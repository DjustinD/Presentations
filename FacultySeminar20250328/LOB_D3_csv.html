<!DOCTYPE html>
<html>
<head>
    <title>Futures OHLC Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        .chart-container {
            width: 800px;
            height: 400px;
            margin: 20px auto;
        }
        .price-line {
            stroke: black;
            stroke-width: 1;
        }
        .open-tick {
            stroke: black;
            stroke-width: 1;
        }
        .close-tick {
            stroke: black;
            stroke-width: 1;
        }
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.3;
        }
        .control-panel {
            width: 800px;
            margin: 20px auto;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            text-align: center;
        }
        .volume-container {
            width: 800px;
            height: 100px;
            margin: 0 auto;
        }
        .volume-bar {
            fill: #888;
        }
        .loading {
            text-align: center;
            font-size: 18px;
            margin: 100px;
        }
    </style>
</head>
<body>
    <div class="loading">Loading data...</div>
    <div class="control-panel" style="display: none;">
        <button id="toggleVolume">Show/Hide Volume</button>
    </div>
    <div class="chart-container"></div>
    <div class="volume-container" style="display: none;"></div>
    
    <script>
        // CSV URL
        const csvUrl = "https://raw.githubusercontent.com/DjustinD/Presentations/refs/heads/main/FacultySeminar20250328/CLZ9_ohlc_vo.csv";
        
        // Function to parse the CSV data
        function parseCSVData(csvData) {
            return d3.csvParse(csvData, d => {
                return {
                    date: d.date,
                    open: +d.open,
                    high: +d.high_trade,
                    low: +d.low_trade,
                    close: +d.settlement,
                    volume: +d.volume,
                    openInterest: +d.open_interest
                };
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Ensure dates are sorted
        }
        
        // Function to create the OHLC chart
        function createOHLCChart(data) {
            document.querySelector('.loading').style.display = 'none';
            document.querySelector('.control-panel').style.display = 'block';
            
            // Set up the chart dimensions
            const margin = { top: 30, right: 30, bottom: 50, left: 60 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            // Create the SVG container
            const svg = d3.select('.chart-container')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create index-based x-scale for even spacing
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width])
                .padding(0.2);
                
            const yScale = d3.scaleLinear()
                .domain([
                    d3.min(data, d => d.low) * 0.998,
                    d3.max(data, d => d.high) * 1.002
                ])
                .range([height, 0]);
            
            // Create custom x-axis ticks for dates
            const xAxis = d3.axisBottom(xScale)
                .tickValues(xScale.domain().filter((d, i) => i % Math.ceil(data.length / 15) === 0)); // Show only every nth label
            
            // Add X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(yScale));
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat('')
                );
            
            // Calculate the width for open/close ticks
            const tickWidth = xScale.bandwidth() / 3;
            
            // Create OHLC elements
            const ohlc = svg.selectAll('.ohlc')
                .data(data)
                .enter()
                .append('g')
                .attr('class', 'ohlc');
            
            // Add vertical lines (high-low range)
            ohlc.append('line')
                .attr('class', 'price-line')
                .attr('x1', d => xScale(d.date) + xScale.bandwidth() / 2)
                .attr('x2', d => xScale(d.date) + xScale.bandwidth() / 2)
                .attr('y1', d => yScale(d.high))
                .attr('y2', d => yScale(d.low));
            
            // Add open tick marks
            ohlc.append('line')
                .attr('class', 'open-tick')
                .attr('x1', d => xScale(d.date) + xScale.bandwidth() / 2 - tickWidth)
                .attr('x2', d => xScale(d.date) + xScale.bandwidth() / 2)
                .attr('y1', d => yScale(d.open))
                .attr('y2', d => yScale(d.open));
            
            // Add close tick marks
            ohlc.append('line')
                .attr('class', 'close-tick')
                .attr('x1', d => xScale(d.date) + xScale.bandwidth() / 2)
                .attr('x2', d => xScale(d.date) + xScale.bandwidth() / 2 + tickWidth)
                .attr('y1', d => yScale(d.close))
                .attr('y2', d => yScale(d.close));
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .text('Futures Daily OHLC Chart');
            
            // Create volume chart
            createVolumeChart(data);
        }
        
        // Function to create the volume chart
        function createVolumeChart(data) {
            const margin = { top: 10, right: 30, bottom: 20, left: 60 };
            const width = 800 - margin.left - margin.right;
            const height = 100 - margin.top - margin.bottom;
            
            // Create the SVG container
            const svg = d3.select('.volume-container')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
                
            // Create scales
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width])
                .padding(0.2);
                
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.volume) * 1.1])
                .range([height, 0]);
                
            // Add X axis (we just need the line, not the ticks)
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickValues([]));
                
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(yScale).ticks(3));
                
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2 + 10)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .text('Volume');
                
            // Add the bars
            svg.selectAll('.volume-bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'volume-bar')
                .attr('x', d => xScale(d.date))
                .attr('y', d => yScale(d.volume))
                .attr('width', xScale.bandwidth())
                .attr('height', d => height - yScale(d.volume));
        }
        
        // Toggle volume display
        document.getElementById('toggleVolume').addEventListener('click', function() {
            const volumeContainer = document.querySelector('.volume-container');
            if (volumeContainer.style.display === 'none') {
                volumeContainer.style.display = 'block';
            } else {
                volumeContainer.style.display = 'none';
            }
        });
        
        // Fetch the CSV data and create the chart
        fetch(csvUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(csvData => {
                const data = parseCSVData(csvData);
                createOHLCChart(data);
            })
            .catch(error => {
                console.error('Error fetching CSV data:', error);
                document.querySelector('.loading').innerHTML = 'Error loading data. Please check console for details.';
            });
    </script>
</body>
</html>
